<html>
<head>
<meta charset="utf-8">
<title>五金APP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
 <meta http-equiv="Access-Control-Allow-Origin" content="*">
<link href="jquery.mobile-1.0.min.css" rel="stylesheet" type="text/css"/>
<script src="jquery-1.6.4.min.js" type="text/javascript"></script>
<script src="jquery.mobile-1.0.min.js" type="text/javascript"></script>

<link href="fivegold.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="iscroll-lite.js"></script>
      				<script type="text/javascript" src="iscroll.js"></script>
<script type="text/javascript" src="fivegold.js"></script>


<script language="javascript">

function genOrder(){

      //document.location.href="addressMange.html";
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://120.24.209.210/api/mobile.php?act=generateorders&user_id=24", true);
	xhr.onreadystatechange = function() {
  		 if (xhr.readyState==4 && xhr.status==200){
    		var resultfromphp = xhr.responseText;
			//alert(resultfromphp);
			
			 var objData = jQuery.parseJSON(resultfromphp);
			 if (objData.consignee){
			 //alert(objData.consignee.consignee);
			var html ='';
			
			 if (objData.consignee.length>0){
				 html+= '<li><h1>收货人信息</h1><select size="1" class="selector" id="selector_consignee">';
				 $.each(objData.consignee, function (index, term) {
		  	 	 html+=' <option value="'+term.address_id+'">'+term.consignee+'('+term.address+')('+term.tel+')</option>';
		     		});
		     		html+='</select></li>';
			 }

                   // html+='<li><h1>收货人信息</h1><p>收货人姓名:'+objData.consignee.consignee+'</p><p>收货人详细地址:'+objData.consignee.address+'</p></li>';
			if (objData.cart_goods.length>0){
				 $.each(objData.cart_goods, function (index, term) {
			 	html+='<li><img src="'+term.goods_thumb+'"/><h1>购物车商品</h1><p>商品名称:'+term.goods_name+'</p><p>商品数量:'+term.goods_number+'</p><p>商品价格:¥'+term.goods_price+'</p></li>';
			 	});
			 }
			 html+='<li><h1>总计</h1><p>商品数量:'+objData.total.real_goods_count+'</p><p>商品总价:¥'+objData.total.goods_price+'</p><p><s>市场总价:¥'+objData.total.market_price+'</s></p><p>节省了:¥'+objData.total.saving_formated+'</p></li>';
		       if (objData.shipping_list.length>0){
				 html+= '<li><h1>快递方式</h1><select size="1" class="selector" id="selector_ship">';
				 $.each(objData.shipping_list, function (index, term) {
		  	 	 html+=' <option value="'+term.shipping_id+'">'+term.shipping_name+'(¥'+term.shipping_fee+')</option>';
		     		});
		     		html+='</select></li>';
			 }
			 if (objData.payment_list.length>0){
				 html+= '<li><h1>支付方式</h1><select size="1" class="selector" id="selector_payment">';
				 $.each(objData.payment_list, function (index, term) {
			       html+=' <option value="'+term.pay_id+'">'+term.pay_name+'(手续费:¥'+term.format_pay_fee+')</option>';
			 		});
			 		html+='</select></li>';
			 }
		      
			 $('#listallcat').append($(html));
                    $('#listallcat').trigger('create');    
                   $('#listallcat').listview('refresh');
                   }
                   if (objData.rsgcode){
			 	alert(objData.rsgmsg);
			 	document.location.href="shopcart.html";
			 }
			 
  		}
	};
	xhr.send();
	
}

function addOrder(){
     var shippingid = $("#selector_ship").val();
     //alert (shippingid);
     var paymentid = $("#selector_payment").val();
     var addressid = $("#selector_consignee").val()
    var need_inv=0;//1要，0不要;
    var inv_type=' ';//发票类型
    var postscript=' ';	//用户备注
   var posturl="http://120.24.209.210/api/mobile.php?act=orderconfirmation&user_id=24&mode=test&shipping_id="+shippingid+'&pay_id='+paymentid+'&need_inv='+need_inv+'&address_id='+addressid;
   //alert (posturl);
      var xhr = new XMLHttpRequest();
	xhr.open("GET", posturl, true);
	xhr.onreadystatechange = function() {
  		 if (xhr.readyState==4 && xhr.status==200){
    		var resultfromphp = xhr.responseText;
			//alert(resultfromphp);
			
			 var objData = jQuery.parseJSON(resultfromphp);
			 document.location.href="listorder.html";
  		}
	};
	xhr.send();
	
}

$(document).ready(function() {
    genOrder();
 });
</script>

</head> 
<body scrolling="no"> 

<div data-role="page" id="5gshoplist">
	<div data-role="header" data-theme="none" id="header" class="home_image">
            <div class="ui-grid-b">
	    <div class="ui-block-a" align="left"><a href="shopcart.html" rel="external" style="-webkit-border-radius:5px; background:-webkit-gradient(linear, 0 0, 0 100%, from(#ffd167), to(#efa823));border:1px solid #b77012;color:#854d00; text-decoration:none;width:80px;height:38px; display:block; text-align:center; line-height:41px;text-shadow:none;font-size:16px;margin-top:1px;">上一步</a></div>
	    <div class="ui-block-b" align="center"><font color="white"><p>生成订单</p></font></div>
	    <div class="ui-block-c" align="right"><a href="javascript:addOrder()" style="-webkit-border-radius:5px; background:-webkit-gradient(linear, 0 0, 0 100%, from(#ffd167), to(#efa823));border:1px solid #b77012;color:#854d00; text-decoration:none;width:80px;height:38px; display:block; text-align:center; line-height:41px;text-shadow:none;font-size:16px;margin-top:1px;">下订单</a></div>
     </div>
     </div>
     		 <div id="wrapper">
	<div id="scroller">
	<div data-role="content" >	
	      
		<ul data-role="listview" id="listallcat">
			
		</ul>
       </div>
       </div>		
	</div>
<div data-role="footer" style="width:100%;height:60px;" id="footer">
		   <div  data-role="navbar">
        <ul>
          <li><a href="go.html" rel="external" data-transition="slide"><img src="images/1.png" height="40"></a></li>
          <li><a href="listallcat.html" rel="external" data-transition="slide"><img src="images/2.png" height="40"></a></li>
          <li><a href="shopcart.html" rel="external" data-transition="slide" data-direction="reverse"><img src="images/3.png" height="40"></a></li>
          <li><a href="go.html#5gmypersonal" rel="external" data-transition="slide"><img src="images/4.png" height="40"></a></li>        
        </ul>
        </div>
	</div>
</div>

</body>
</html>
